{"version":3,"sources":["../../../../server/api/actions/signUpEpicc.js"],"names":["signUp","req","reqSecured","usersAllowedAttributes","Promise","resolve","reject","redisKey","then","userData","ticketData","body","email","toLowerCase","userProfile","existingValue","EMAIL_TAKEN","filter","ticketCanBeReserved","ticketType","ticket","Date","now","TICKET_SALE_END","error","createdUser","loginResult"],"mappings":";;;;;;;;;AAAA;;AAEA;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEe,SAASA,MAAT,CAAgBC,GAAhB,EAAqB;AAClC,MAAMC,UAAU,GAAG,2BAAUD,GAAV,EAAeE,kCAAf,CAAnB;AACA,SAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC;AACA,0BAAU;AAAEC,MAAAA,QAAQ,EAAE;AAAZ,KAAV,EAAiCC,IAAjC,CAAsC,UAAAC,QAAQ,EAAI;AAChD,4BAAU;AAAEF,QAAAA,QAAQ,EAAE;AAAZ,OAAV,EAAmCC,IAAnC,CAAwC,UAAAE,UAAU,EAAI;AAAA,oBACb,iBACrCD,QADqC,EAErCP,UAAU,CAACS,IAAX,CAAgBC,KAAhB,CAAsBC,WAAtB,EAFqC,EAGrC,OAHqC,CADa;AAAA,YAC7BC,WAD6B,SAC5CC,aAD4C;;AAMpD,YAAID,WAAJ,EAAiB;AACfT,UAAAA,OAAO,CAACW,sBAAD,CAAP;AACD,SAFD,MAEO;AAAA,uBAC2B,iBAC9BN,UAAU,CAACO,MAAX,CAAkBC,8BAAlB,CAD8B,EAE9BhB,UAAU,CAACS,IAAX,CAAgBQ,UAFc,EAG9B,YAH8B,CAD3B;AAAA,cACgBC,MADhB,UACCL,aADD;;AAML,cAAIM,IAAI,CAACC,GAAL,KAAaC,0BAAjB,EAAkC;AAChClB,YAAAA,OAAO,CAAC;AAAEmB,cAAAA,KAAK,EAAE;AAAT,aAAD,CAAP;AACD,WAFD,MAEO,IAAI,CAACJ,MAAL,EAAa;AAClBf,YAAAA,OAAO,CAAC;AAAEmB,cAAAA,KAAK,EAAE;AAAT,aAAD,CAAP;AACD,WAFM,MAEA;AACLtB,YAAAA,UAAU,CAACS,IAAX,CAAgBC,KAAhB,GAAwBV,UAAU,CAACS,IAAX,CAAgBC,KAAhB,CAAsBC,WAAtB,EAAxB;AACA,oCACE;AAAEN,cAAAA,QAAQ,EAAE;AAAZ,aADF,EAEE;AAAEI,cAAAA,IAAI,EAAE;AAAEC,gBAAAA,KAAK,EAAEV,UAAU,CAACS,IAAX,CAAgBC;AAAzB;AAAR,aAFF,EAGEJ,IAHF,CAGO,UAAAiB,WAAW,EAAI;AACpB,qCAAUvB,UAAV,EAAsBuB,WAAtB,EAAmCjB,IAAnC,CAAwC,UAAAkB,WAAW,EAAI;AACrDN,gBAAAA,MAAM,GAAG,8BAAcA,MAAd,EAAsBK,WAAtB,EAAmC,IAAnC,CAAT;AACA,wCAAY;AAAElB,kBAAAA,QAAQ,EAAE;AAAZ,iBAAZ,EAAqC;AAAEI,kBAAAA,IAAI,EAAES;AAAR,iBAArC,EAAuDZ,IAAvD,CACE,YAAM;AACJ,gEAA2BkB,WAA3B;AACArB,kBAAAA,OAAO,CAACqB,WAAD,CAAP;AACD,iBAJH;AAMD,eARD;AASD,aAbD;AAcD;AACF;AACF,OApCD;AAqCD,KAtCD;AAuCD,GAzCM,CAAP;AA0CD","sourcesContent":["import { datumLoad, datumCreate, datumUpdate } from '../actions/datum';\n\nimport usersAllowedAttributes from './users/usersAllowedAttributes';\n\nimport { find } from 'utils/find';\nimport { EMAIL_TAKEN, TICKET_SALE_END } from 'helpers/constants';\nimport { ticketCanBeReserved, reserveTicket } from 'helpers/ticketing';\nimport reqSecure from 'utils/reqSecure';\nimport loginUser from 'utils/login';\nimport { sendEmailVerificationEmail } from 'utils/emailHelpers';\n\nexport default function signUp(req) {\n  const reqSecured = reqSecure(req, usersAllowedAttributes);\n  return new Promise((resolve, reject) => {\n    // Using datum load as we want to avoid invoking authentication when loading users data here\n    datumLoad({ redisKey: 'users' }).then(userData => {\n      datumLoad({ redisKey: 'tickets' }).then(ticketData => {\n        const { existingValue: userProfile } = find(\n          userData,\n          reqSecured.body.email.toLowerCase(),\n          'email',\n        );\n        if (userProfile) {\n          resolve(EMAIL_TAKEN);\n        } else {\n          let { existingValue: ticket } = find(\n            ticketData.filter(ticketCanBeReserved),\n            reqSecured.body.ticketType,\n            'ticketType',\n          );\n          if (Date.now() > TICKET_SALE_END) {\n            resolve({ error: 'Ticket sales are now closed.' });\n          } else if (!ticket) {\n            resolve({ error: 'Ticket type is sold out.' });\n          } else {\n            reqSecured.body.email = reqSecured.body.email.toLowerCase();\n            datumCreate(\n              { redisKey: 'users' },\n              { body: { email: reqSecured.body.email } },\n            ).then(createdUser => {\n              loginUser(reqSecured, createdUser).then(loginResult => {\n                ticket = reserveTicket(ticket, createdUser, null);\n                datumUpdate({ redisKey: 'tickets' }, { body: ticket }).then(\n                  () => {\n                    sendEmailVerificationEmail(loginResult);\n                    resolve(loginResult);\n                  },\n                );\n              });\n            });\n          }\n        }\n      });\n    });\n  });\n}\n"],"file":"signUpEpicc.js"}