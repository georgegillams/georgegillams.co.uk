{"version":3,"sources":["../../../../server/api/actions/getmagiclink.js"],"names":["getmagiclink","req","reqSecured","usersAllowedAttributes","Promise","resolve","then","user","redisKey","userData","body","email","toLowerCase","userProfile","existingValue","divertToAdmin","admin","loginRedirect","success"],"mappings":";;;;;;;;;AAAA;;AAEA;;AAEA;;AACA;;AACA;;AACA;;AAEe,SAASA,YAAT,CAAsBC,GAAtB,EAA2B;AACxC,MAAMC,UAAU,GAAG,2BAAUD,GAAV,EAAeE,kCAAf,CAAnB;AACA,SAAO,IAAIC,OAAJ,CAAY,UAAAC,OAAO,EAAI;AAC5B,oCAAeJ,GAAf,EAAoBK,IAApB,CAAyB,UAAAC,IAAI,EAAI;AAC/B,4BAAU;AAAEC,QAAAA,QAAQ,EAAE;AAAZ,OAAV,EAAiCF,IAAjC,CAAsC,UAAAG,QAAQ,EAAI;AAAA,oBACT,iBACrCA,QADqC,EAErCP,UAAU,CAACQ,IAAX,CAAgBC,KAAhB,CAAsBC,WAAtB,EAFqC,EAGrC,OAHqC,CADS;AAAA,YACzBC,WADyB,SACxCC,aADwC;;AAMhD,YAAID,WAAJ,EAAiB;AACf,cAAME,aAAa,GACjBR,IAAI,IAAIA,IAAI,CAACS,KAAb,IAAsBd,UAAU,CAACQ,IAAX,CAAgBK,aADxC;AAEA,gDACEF,WADF,EAEEE,aAFF,EAGEb,UAAU,CAACQ,IAAX,CAAgBO,aAHlB;AAKD;;AACDZ,QAAAA,OAAO,CAAC;AACNa,UAAAA,OAAO,EACL;AAFI,SAAD,CAAP;AAID,OAnBD;AAoBD,KArBD;AAsBD,GAvBM,CAAP;AAwBD","sourcesContent":["import { datumLoad } from '../actions/datum';\n\nimport usersAllowedAttributes from './users/usersAllowedAttributes';\n\nimport { find } from 'utils/find';\nimport authentication from 'utils/authentication';\nimport { sendMagicLinkEmail } from 'utils/emailHelpers';\nimport reqSecure from 'utils/reqSecure';\n\nexport default function getmagiclink(req) {\n  const reqSecured = reqSecure(req, usersAllowedAttributes);\n  return new Promise(resolve => {\n    authentication(req).then(user => {\n      datumLoad({ redisKey: 'users' }).then(userData => {\n        const { existingValue: userProfile } = find(\n          userData,\n          reqSecured.body.email.toLowerCase(),\n          'email',\n        );\n        if (userProfile) {\n          const divertToAdmin =\n            user && user.admin && reqSecured.body.divertToAdmin;\n          sendMagicLinkEmail(\n            userProfile,\n            divertToAdmin,\n            reqSecured.body.loginRedirect,\n          );\n        }\n        resolve({\n          success:\n            'A magic link has been generated and sent to the email associated with your account',\n        });\n      });\n    });\n  });\n}\n"],"file":"getmagiclink.js"}